name: AI Autonomous Developer (RockDeals POS)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # للتشغيل اليدوي الشامل
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write  # السماح بالتعديل الفعلي على الملفات
  pull-requests: write
  issues: write

jobs:
  ai-developer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gemini AI - Generate Fixes & Restructure
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini-api-key: ${{ secrets.GEMINI_API_KEY }}
          # نطلب من الذكاء الاصطناعي إنتاج سكربت Shell لتنفيذ التغييرات
          prompt: |
            أنت مهندس برمجيات خبير ومدير تقني لمشروع "RockDeals-POS-System".
            بناءً على ملف "architecture_rules.md" والمحتوى الحالي للمستودع:
            1. ابحث عن الأخطاء البرمجية (Logic errors, Syntax) وأصلحها.
            2. أعد تنظيم الملفات لتناسب هيكلية مشروع POS احترافي.
            3. قم بتحديث التوثيق (README.md).
            مهم جداً: قم بإخراج الإجابة كـ Shell Script كامل (bash) يقوم بعمليات (mkdir, mv, echo, cat) لتعديل الملفات.
            اجعل الكود داخل علامات ```bash ... ``` فقط.

      - name: Extract and Execute AI Script
        run: |
          # استخراج السكربت من مخرجات Gemini وتشغيله
          # نفترض أن المخرج تم حفظه في متغير الخطوة السابقة
          echo "${{ steps.gemini.outputs.response }}" | grep -Pzo '(?<=```bash\n)[\s\S]*?(?=\n```)' > apply_changes.sh
          if [ -s apply_changes.sh ]; then
            chmod +x apply_changes.sh
            ./apply_changes.sh
            rm apply_changes.sh
          else
            echo "No changes suggested by AI."
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI Autonomous: Bug fixes and structural improvements"
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: '*'
